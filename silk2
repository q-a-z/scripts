# Install Link
# https://www.youtube.com/watch?v=5fLhb6EHvyw&index=1&list=PLSNlEg26NNpyBCKGeWaYWyuZPGfkaPWAM

#BEFORE DOING ANYTHING DOWNLOAD 
  #download libschemaTools.tar.gz
  #tar -xvzf libschema*
  #cd libschema*
  #./configure & make & make install
  
  #download libfixbuf
  #tar -xvzf libfixbuf*
  #cd libfixbuf*
  #./configure & make & make install
  
  #download netsa-python
  #tar -xvzf netsa*
  #cd netsa*
  #python setup.py build
  #python setup.py install
  
  #download rayon
  #tar -xvzf rayon*
  #cd rayon*
  #python setup.py install

#Check packages for latest release..curl command does this.
#You will need to edit the interfaces when starting YAF
#You will need to determine your internal network for Sensors.conf file

#~~~~~~~~~~SCRIPT START~~~~~~~~~
#VARIABLES
home=$(echo ~)
workingdir=$home'/tmp'

#Download dependencies
apt-get -y install libglib2.0-dev
apt-get -y install libpcap-dev
apt-get -y install python-dev

#Make a tmp directory in your home directory
mkdir $workingdir
cd $workingdir

###GET LATEST VERSION INFO FROM NETSA"###
for x in $(curl http://tools.netsa.cert.org/ | grep "tar.gz" | cut -d"/" -f4 | cut -d'"' -f1)
  do wget http://tools.netsa.cert.org/releases/$x
done

#Install YAF
cd $workingdir
tar -zxvf yaf-*
cd yaf-*
export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
./configure --enable-applabel
make
make install

# Make data directory
mkdir /data

#Build and install SiLK 
cd $workingdir
tar -xvzf silk-*
cd silk-*
./configure \
 --with-libfixbuf=/usr/local/lib/pkgconfig/ \
 --with-python --enable-ipv6
make & make install

#Add Silk to ld.so.conf
cat <<EOF >>silk.conf
/usr/local/lib
/usr/local/lib/silk
EOF
mv silk.conf /etc/ld.so.conf.d/
ldconfig

#Make PipeLine
cd $workingdir
tar-xvzf analysis*
cd analysis*
./configure & make & make install

ldconfig

#~~~~~~~~~~~END OF NEW SCRIPT~~~~~~~~~~~~~

#Create Silk Conf File
cd $workingdir/silk-2.5.0
cp site/twoway/silk.conf /data

#Create Sensors.conf File
cat <<EOF >sensors.conf
probe S0 ipfix
 listen-on-port 18001
 protocol tcp
 listen-as-host 127.0.0.1
end probe
group my-network
 ipblocks 192.168.1.0/24 # address of eth0. CHANGE THIS.
 ipblocks 10.0.0.0/8 # other blocks you consider internal
end group
sensor S0
 ipfix-probes S0
 internal-ipblocks @my-network
 external-ipblocks remainder
end sensor
EOF

#Configure rwflowpack
cat /usr/local/share/silk/etc/rwflowpack.conf | \
sed 's/ENABLED=/ENABLED=yes/;' | \
sed 's/SENSOR_CONFIG=/SENSOR_CONFIG=\/data\/sensors.conf/;' | \
sed 's/SITE_CONFIG=/SITE_CONFIG=\/data\/silk.conf/' | \
sed 's/LOG_TYPE=syslog/LOG_TYPE=legacy/' | \
sed 's/LOG_DIR=.*/LOG_DIR=\/var\/log/' | \
sed 's/CREATE_DIRECTORIES=.*/CREATE_DIRECTORIES=yes/' \
>> rwflowpack.conf
mv rwflowpack.conf /usr/local/etc/
mv sensors.conf /data

#Create Startup Scripts and Start Service
cp /usr/local/share/silk/etc/init.d/rwflowpack /etc/init.d
update-rc.d rwflowpack start 20 3 4 5 .
service rwflowpack start

#Start Yaf
nohup /usr/local/bin/yaf --silk --ipfix=tcp --live=pcap  --out=127.0.0.1 \
  --ipfix-port=18001 --in=eth0 --applabel --max-payload=384 &

#Test query
#/usr/local/bin/rwfilter --sensor=S0 --proto=0-255 --pass=stdout --type=all | rwcut | tail
